<table class="invoice-table">
  <thead>
    <tr>
      <th>Р.б</th>
      <th>Опис</th>
      <th>Е М</th>
      <th>Количина</th>
      <th>Цена без ДДВ</th>
      <th>Цена со ДДВ</th>
      <th>Рабат %</th>
      <th>Износ на Рабат</th>
      <th>ДДВ %</th>
      <th>Износ со ДДВ</th>
      <th></th>
    </tr>
  </thead>

  <tbody>
    <tr *ngFor="let item of items; let i = index">
      <td
        [style.font-size.px]="currentFontSize"
        [style.padding.px]="paddingSize"
      >
        {{ i + 1 }}.
      </td>

      <!-- Опис -->
      <td [style.padding.px]="paddingSize">
        <textarea
          #ta
          class="cell-input cell-opis"
          [style.font-size.px]="currentFontSize"
          [attr.data-row]="i"
          data-field="opis"
          [(ngModel)]="items[i].opis"
          (ngModelChange)="emitItems()"
          [disabled]="isLocked(i)"
          (input)="autoResize(ta)"
          (keydown.enter)="handleEnter(i, 'opis', $event)"
          rows="1"
        ></textarea>
      </td>

      <!-- ЕМ -->
      <td [style.padding.px]="paddingSize">
        <input
          #cellInput
          class="cell-input cell-small"
          [style.font-size.px]="currentFontSize"
          [attr.data-row]="i"
          data-field="em"
          [(ngModel)]="items[i].em"
          (ngModelChange)="emitItems()"
          [disabled]="isLocked(i)"
          (keydown.enter)="handleEnter(i, 'em', $event)"
        />
      </td>

      <!-- Количина -->
      <td [style.padding.px]="paddingSize">
        <input
          #cellInput
          class="cell-input cell-num"
          [style.font-size.px]="currentFontSize"
          [attr.data-row]="i"
          data-field="kolicina"
          type="number"
          step="1"
          min="0"
          [ngModel]="items[i].kolicina"
          (ngModelChange)="setNumber(i, 'kolicina', $event)"
          [disabled]="isLocked(i)"
          (keydown.enter)="handleEnter(i, 'kolicina', $event)"
        />
      </td>

      <!-- Цена без данок -->
      <td [style.padding.px]="paddingSize">
        <input
          #cellInput
          class="cell-input cell-num"
          [style.font-size.px]="currentFontSize"
          [attr.data-row]="i"
          data-field="cenaBezDanok"
          type="number"
          step="1"
          min="0"
          [ngModel]="items[i].cenaBezDanok"
          (ngModelChange)="setNumber(i, 'cenaBezDanok', $event)"
          (blur)="format2(i, 'cenaBezDanok')"
          [disabled]="isLocked(i)"
          (keydown.enter)="handleEnter(i, 'cenaBezDanok', $event)"
        />
      </td>

      <!-- ✅ Цена со ДДВ -->
      <td [style.padding.px]="paddingSize">
        <input
          #cellInput
          class="cell-input cell-num"
          [style.font-size.px]="currentFontSize"
          [attr.data-row]="i"
          data-field="cenaSoDdv"
          type="number"
          step="1"
          min="0"
          [ngModel]="items[i].cenaSoDdv"
          (ngModelChange)="setNumber(i, 'cenaSoDdv', $event)"
          (blur)="format2(i, 'cenaSoDdv')"
          [disabled]="isLocked(i)"
          (keydown.enter)="handleEnter(i, 'cenaSoDdv', $event)"
        />
      </td>

      <!-- Рабат % -->
      <td [style.padding.px]="paddingSize">
        <input
          #cellInput
          class="cell-input cell-num"
          [style.font-size.px]="currentFontSize"
          [attr.data-row]="i"
          data-field="rabatProcent"
          type="number"
          step="1"
          [ngModel]="items[i].rabatProcent ?? 0"
          (ngModelChange)="setNumber(i, 'rabatProcent', $event)"
          [disabled]="isLocked(i)"
          (keydown.enter)="handleEnter(i, 'rabatProcent', $event)"
        />
      </td>

      <!-- Рабат (computed line discount) -->
      <td
        [style.font-size.px]="currentFontSize"
        [style.padding.px]="paddingSize"
        style="text-align: right"
      >
        {{ discountValue(item) | number: "1.2-2" }}
      </td>

      <!-- ДДВ % -->
      <td [style.padding.px]="paddingSize">
        <input
          #cellInput
          class="cell-input cell-num"
          [style.font-size.px]="currentFontSize"
          [attr.data-row]="i"
          data-field="ddv"
          type="number"
          step="1"
          [ngModel]="items[i].ddv ?? 0"
          (ngModelChange)="setNumber(i, 'ddv', $event)"
          [disabled]="isLocked(i)"
          (keydown.enter)="handleEnter(i, 'ddv', $event)"
        />
      </td>

      <!-- Износ со ДДВ -->
      <td
        [style.font-size.px]="currentFontSize"
        [style.padding.px]="paddingSize"
        style="text-align: right"
      >
        {{ totalWithVat(item) | number: "1.2-2" }}
      </td>

      <td class="deleteEntry">
        <button mat-icon-button (click)="remove.emit(i)">
          <mat-icon>delete</mat-icon>
        </button>

        <!-- Optional: lock/edit mode -->
        <button mat-icon-button (click)="toggleLock(i)" *ngIf="lockMode">
          <mat-icon>{{ isLocked(i) ? "lock" : "edit" }}</mat-icon>
        </button>
      </td>
    </tr>
  </tbody>
</table>
